Bootstrap: docker
From: fedora:latest

%setup
    # Create cache directories in container for bind mounts
    mkdir -p ${APPTAINER_ROOTFS}/root/.cache/pip
    mkdir -p ${APPTAINER_ROOTFS}/var/cache/dnf

%post

    # Use host dnf cache when available
    echo "keepcache=1" >> /etc/dnf/dnf.conf

    dnf -y update

    echo "Installing necessary build tools and dependencies..."
    dnf -y install \
        hostname which \
        vim \
        wget curl \
        bzip2 unzip \
        git subversion mercurial patch \
        gcc gcc-c++ gfortran clang \
        make cmake \
        pandoc \
        python3.14 python3.14-devel python3.14-pip \
        boost-devel boost-python3-devel \
        libedit-devel \
        openblas-devel lapack-devel blas-devel \
        suitesparse-devel \
        cppunit-devel \
        proj-devel geos-devel

    # Create installation directory for gimli
    mkdir -p /opt/gimli
    cd /opt/gimli

    echo "Cloning pygimli source..."
    git clone https://github.com/gimli-org/gimli.git

    # Python build toolchain
    python3.14 -m pip install --upgrade pip setuptools wheel

    # Core scientific stack (needed for gimli build)
    python3.14 -m pip install numpy matplotlib scipy

    # Sphinx documentation toolchain (needed for cmake to find sphinx-build)
    python3.14 -m pip install sphinx sphinx-book-theme sphinx-design sphinx-togglebutton myst-nb sphinx-gallery pypandoc sphinxcontrib-mermaid sphinx-copybutton

    # Gimli dev requirements
    if [ -f /opt/gimli/gimli/dev_requirements.txt ]; then
        python3.14 -m pip install -r /opt/gimli/gimli/dev_requirements.txt
    fi

    # Build gimli from source (out of source build)
    mkdir -p /opt/gimli/build
    cd /opt/gimli/build

    # Manually download and build Triangle (wget2 has issues with the auto-download)
    mkdir -p /opt/gimli/thirdParty/src/triangle
    cd /opt/gimli/thirdParty/src/triangle
    curl -L -o triangle.zip http://www.netlib.org/voronoi/triangle.zip
    unzip -o triangle.zip
    # Build Triangle as a library (use C89 standard for old K&R code)
    cc -std=gnu89 -O -DLINUX -DTRILIBRARY -DNO_TIMER -fPIC -c triangle.c
    ar r libtriangle.a triangle.o
    # Install Triangle
    mkdir -p /opt/gimli/thirdParty/dist-GNU-15.2.1-64/lib
    mkdir -p /opt/gimli/thirdParty/dist-GNU-15.2.1-64/include
    cp libtriangle.a /opt/gimli/thirdParty/dist-GNU-15.2.1-64/lib/
    cp triangle.h /opt/gimli/thirdParty/dist-GNU-15.2.1-64/include/
    cd /opt/gimli/build

    cmake ../gimli \
        -DPYVERSION=3.14 \
        -DPython_EXECUTABLE=/usr/bin/python3.14 \
        -DPython_INCLUDE_DIR=/usr/include/python3.14 \
        -DTriangle_INCLUDE_DIR=/opt/gimli/thirdParty/dist-GNU-15.2.1-64/include \
        -DTriangle_LIBRARIES=/opt/gimli/thirdParty/dist-GNU-15.2.1-64/lib/libtriangle.a
    make -j$(nproc) gimli
    make pygimli J=$(nproc)

    # Verify the build
    cd /opt/gimli
    export PYTHONPATH=/opt/gimli/gimli:$PYTHONPATH
    export LD_LIBRARY_PATH=/opt/gimli/build/lib:$LD_LIBRARY_PATH
    python3.14 -c 'import pygimli as pg; print(pg.__version__)'

    # Additional scientific / numerical packages
    python3.14 -m pip install numba llvmlite
    python3.14 -m pip install "seaborn>=0.13" cmcrameri
    python3.14 -m pip install shapely cartopy
    python3.14 -m pip install smt

    # Geophysics / seismology
    python3.14 -m pip install git+https://github.com/obspy/obspy.git
    python3.14 -m pip install seislib
    python3.14 -m pip install astroquery

    # InLab geoscience packages
    python3.14 -m pip install git+https://github.com/inlab-geo/cofi@bayesbay-p314-fix
    python3.14 -m pip install git+https://github.com/inlab-geo/pyfm2d
    python3.14 -m pip install git+https://github.com/inlab-geo/pyrf96
    python3.14 -m pip install git+https://github.com/inlab-geo/pyhk
    python3.14 -m pip install git+https://github.com/inlab-geo/pysurf96
    python3.14 -m pip install git+https://github.com/JuergHauser/PyP223.git

    # Jupyter / notebook environment
    python3.14 -m pip install jupyterlab notebook
    python3.14 -m pip install --upgrade ipython ipykernel
    python3.14 -m pip install papermill nbformat
    python3.14 -m pip install marimo
    python3.14 -m ipykernel install --name "python3"

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export PYTHONPATH=/opt/gimli/gimli:$PYTHONPATH
    export LD_LIBRARY_PATH=/opt/gimli/build/lib:$LD_LIBRARY_PATH
    export PATH=/opt/gimli/build/bin:$PATH
    export PROMPT_DIRTRIM=2
    export PS1='[\u@\h \w]\$ '
